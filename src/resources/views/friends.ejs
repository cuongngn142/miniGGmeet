<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bạn bè</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/public/styles.css" />
  </head>
  <body>
    <div class="container py-4">
      <header class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="fw-bold">Bạn bè</h1>
        <div>Xin chào, <b><%= user.displayName %></b></div>
      </header>

      <main class="grid2">
        <section class="card card-3d p-4">
          <h3 class="h5">Gửi lời mời kết bạn</h3>
          <div class="alert alert-danger d-none" id="sendErrorAlert"></div>
          <div class="alert alert-success d-none" id="sendSuccessAlert"></div>
          <form class="row g-3" id="sendRequestForm">
            <div class="col-12">
              <label class="form-label">Email</label>
              <input class="form-control" name="email" type="email" placeholder="vd: user@example.com" required />
            </div>
            <div class="col-12">
              <button class="btn btn-primary btn-3d" type="submit" id="sendBtn">
                <span class="spinner-border spinner-border-sm d-none" id="sendSpinner"></span>
                <span id="sendText">Gửi lời mời</span>
              </button>
            </div>
          </form>
        </section>

        <section class="card card-3d p-4">
          <h3 class="h5">Lời mời kết bạn</h3>
          <div id="requestsList" class="list-group">
            <% me.friendRequests.forEach(fr => { %>
              <div class="list-group-item d-flex justify-content-between align-items-center" data-request-id="<%= fr._id %>">
                <span><b><%= fr.displayName %></b> <small class="text-muted">(<%= fr.email %>)</small></span>
                <div>
                  <button class="btn btn-success btn-sm accept-btn" data-requester-id="<%= fr._id %>">
                    <span class="spinner-border spinner-border-sm d-none"></span>
                    <span class="btn-text">Chấp nhận</span>
                  </button>
                  <button class="btn btn-danger btn-sm ms-1 reject-btn" data-requester-id="<%= fr._id %>">
                    <span class="spinner-border spinner-border-sm d-none"></span>
                    <span class="btn-text">Từ chối</span>
                  </button>
                </div>
              </div>
            <% }) %>
            <% if (me.friendRequests.length === 0) { %>
              <div class="text-muted text-center py-3">Không có lời mời nào</div>
            <% } %>
          </div>
        </section>

        <section class="card card-3d p-4" style="grid-column: span 2;">
          <h3 class="h5">Danh sách bạn bè</h3>
          <div id="friendsList" class="list-group">
            <% me.friends.forEach(f => { %>
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="/dm/<%= [user.id, f._id].sort().join('') %>">
                <span><b><%= f.displayName %></b> <small class="text-muted">(<%= f.email %>)</small></span>
                <span class="text-primary"><i class="bi bi-chat-dots"></i> Nhắn tin/Gọi video</span>
              </a>
            <% }) %>
            <% if (me.friends.length === 0) { %>
              <div class="text-muted text-center py-3">Chưa có bạn bè nào</div>
            <% } %>
          </div>
        </section>
      </main>
    </div>
    <script src="/public/js/api/user.api.js"></script>
    <script>
      // Send friend request
      const sendRequestForm = document.getElementById('sendRequestForm')
      const sendErrorAlert = document.getElementById('sendErrorAlert')
      const sendSuccessAlert = document.getElementById('sendSuccessAlert')
      const sendBtn = document.getElementById('sendBtn')
      const sendSpinner = document.getElementById('sendSpinner')
      const sendText = document.getElementById('sendText')

      sendRequestForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const formData = new FormData(sendRequestForm)
        const email = formData.get('email')
        
        // Show loading
        sendBtn.disabled = true
        sendSpinner.classList.remove('d-none')
        sendText.textContent = 'Đang gửi...'
        sendErrorAlert.classList.add('d-none')
        sendSuccessAlert.classList.add('d-none')
        
        try {
          await userAPI.sendFriendRequest(email)
          
          // Show success
          sendSuccessAlert.textContent = 'Đã gửi lời mời kết bạn!'
          sendSuccessAlert.classList.remove('d-none')
          sendRequestForm.reset()
          
        } catch (error) {
          // Show error
          sendErrorAlert.textContent = error.message
          sendErrorAlert.classList.remove('d-none')
        } finally {
          // Reset button
          sendBtn.disabled = false
          sendSpinner.classList.add('d-none')
          sendText.textContent = 'Gửi lời mời'
        }
      })

      // Accept friend request
      document.querySelectorAll('.accept-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const requesterId = btn.dataset.requesterId
          const spinner = btn.querySelector('.spinner-border')
          const text = btn.querySelector('.btn-text')
          
          // Show loading
          btn.disabled = true
          spinner.classList.remove('d-none')
          text.textContent = 'Đang xử lý...'
          
          try {
            await userAPI.acceptFriendRequest(requesterId)
            
            // Remove from list and reload
            window.location.reload()
          } catch (error) {
            alert('Lỗi: ' + error.message)
            
            // Reset button
            btn.disabled = false
            spinner.classList.add('d-none')
            text.textContent = 'Chấp nhận'
          }
        })
      })

      // Reject friend request
      document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const requesterId = btn.dataset.requesterId
          const spinner = btn.querySelector('.spinner-border')
          const text = btn.querySelector('.btn-text')
          
          // Show loading
          btn.disabled = true
          spinner.classList.remove('d-none')
          text.textContent = 'Đang xử lý...'
          
          try {
            await userAPI.rejectFriendRequest(requesterId)
            
            // Remove from list
            const item = btn.closest('[data-request-id]')
            item.remove()
            
            // Check if list empty
            const list = document.getElementById('requestsList')
            if (list.querySelectorAll('[data-request-id]').length === 0) {
              list.innerHTML = '<div class="text-muted text-center py-3">Không có lời mời nào</div>'
            }
          } catch (error) {
            alert('Lỗi: ' + error.message)
            
            // Reset button
            btn.disabled = false
            spinner.classList.add('d-none')
            text.textContent = 'Từ chối'
          }
        })
      })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
