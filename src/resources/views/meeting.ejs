<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Phòng họp - <%= room.title %></title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
		<link rel="stylesheet" href="/styles.css" />
	</head>
	<body>
		<div class="meeting-layout">
			<header class="meeting-header">
				<div class="d-flex align-items-center gap-3">
					<h6 class="mb-0 fw-bold"><%= room.title %></h6>
					<span class="badge bg-secondary">Mã: <%= room.code %></span>
				</div>
				<div class="d-flex align-items-center gap-3">
					<span class="text-muted" id="meetingClock"></span>
					<span class="text-light"><i class="bi bi-person-circle me-1"></i><%= user.displayName %></span>
				</div>
			</header>

			<div class="meeting-main">
				<section class="video-grid" id="videoGrid">
					<div class="video-tile" id="tile-local" data-user-id="<%= user.id %>">
						<video id="localVideo" autoplay muted playsinline></video>
						<div class="avatar" id="avatar-local"></div>
						<div class="name-tag"><%= user.displayName %></div>
					</div>
				</section>
				<aside class="sidebar">
					<div class="tabs">
						<button data-tab="chat" class="active"><i class="bi bi-chat-dots me-2"></i>Chat</button>
						<button data-tab="youtube"><i class="bi bi-youtube me-2"></i>YouTube</button>
					</div>
					<div class="tab-content" id="tab-chat">
						<div id="chatList" class="chat-list"></div>
						<div class="chat-input">
							<input id="chatMsg" class="form-control form-control-sm" placeholder="Gửi tin nhắn cho mọi người..." />
							<button id="sendBtn" class="btn btn-sm btn-primary"><i class="bi bi-send-fill"></i></button>
						</div>
					</div>
					<div class="tab-content hidden" id="tab-youtube">
						<div class="mb-2">
							<input id="ytUrl" class="form-control form-control-sm" placeholder="Dán URL YouTube hoặc ID video" />
						</div>
						<div class="yt-controls">
							<button id="ytLoad" class="btn btn-sm btn-success flex-fill"><i class="bi bi-play-circle me-1"></i>Phát</button>
							<button id="ytPause" class="btn btn-sm btn-warning flex-fill"><i class="bi bi-pause-circle me-1"></i>Tạm dừng</button>
						</div>
						<div id="ytEmbed" class="yt-embed"></div>
					</div>
				</aside>
			</div>

			<footer class="toolbar">
				<button id="micBtn" class="tool-btn" title="Tắt/Bật mic" aria-label="Mic"><i class="bi bi-mic-fill"></i></button>
				<button id="camBtn" class="tool-btn" title="Tắt/Bật camera" aria-label="Camera"><i class="bi bi-camera-video-fill"></i></button>
				<button id="screenBtn" class="tool-btn" title="Chia sẻ màn hình" aria-label="Chia sẻ màn hình"><i class="bi bi-display"></i></button>
				<button id="layoutBtn" class="tool-btn" title="Điều chỉnh chế độ xem" aria-label="Layout" data-bs-toggle="modal" data-bs-target="#layoutModal"><i class="bi bi-grid-3x3-gap"></i></button>
				<button id="chatToggleBtn" class="tool-btn" title="Đóng/Mở chat" aria-label="Toggle chat" aria-pressed="true"><i class="bi bi-chat-dots-fill"></i></button>
				<button id="raiseBtn" class="tool-btn" title="Giơ tay" aria-label="Giơ tay"><i class="bi bi-hand-index-thumb"></i></button>
				<button id="recordBtn" class="tool-btn" title="Ghi lại" aria-label="Ghi lại"><i class="bi bi-record-circle"></i></button>
				
				<!-- NEW: Additional Controls -->
				<button id="filesBtn" class="tool-btn" title="Chia sẻ file" aria-label="Files" data-bs-toggle="modal" data-bs-target="#filesModal"><i class="bi bi-folder"></i></button>
				<button id="rolesBtn" class="tool-btn" title="Phân quyền" aria-label="Roles" data-bs-toggle="modal" data-bs-target="#rolesModal"><i class="bi bi-shield-check"></i></button>
				<button id="breakoutBtn" class="tool-btn" title="Breakout Rooms" aria-label="Breakout" data-bs-toggle="modal" data-bs-target="#breakoutModal"><i class="bi bi-grid-3x2"></i></button>
				
				<a class="leave" href="/" title="Rời phòng"><i class="bi bi-telephone-x-fill"></i></a>
			</footer>
		</div>

		<!-- Layout Settings Modal -->
		<div class="modal fade" id="layoutModal" tabindex="-1" aria-labelledby="layoutModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content bg-dark text-light border-secondary">
					<div class="modal-header border-secondary">
						<h5 class="modal-title" id="layoutModalLabel">Điều chỉnh chế độ xem</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<p class="text-muted small mb-3">Đã lưu lựa chọn cho các cuộc họp về sau</p>
						
						<!-- Layout Options -->
						<div class="mb-4">
							<div class="form-check mb-3">
								<input class="form-check-input" type="radio" name="layoutMode" id="layoutAuto" value="auto" checked>
								<label class="form-check-label d-flex align-items-center justify-content-between w-100" for="layoutAuto">
									<span>Tự động (linh động) <i class="bi bi-pin-angle-fill ms-1"></i></span>
									<div class="layout-preview layout-auto"></div>
								</label>
							</div>
							<div class="form-check mb-3">
								<input class="form-check-input" type="radio" name="layoutMode" id="layoutTiled" value="tiled">
								<label class="form-check-label d-flex align-items-center justify-content-between w-100" for="layoutTiled">
									<span>Ô (cũ)</span>
									<div class="layout-preview layout-tiled"></div>
								</label>
							</div>
							<div class="form-check mb-3">
								<input class="form-check-input" type="radio" name="layoutMode" id="layoutSpotlight" value="spotlight">
								<label class="form-check-label d-flex align-items-center justify-content-between w-100" for="layoutSpotlight">
									<span>Tiêu điểm</span>
									<div class="layout-preview layout-spotlight"></div>
								</label>
							</div>
							<div class="form-check mb-3">
								<input class="form-check-input" type="radio" name="layoutMode" id="layoutSidebar" value="sidebar">
								<label class="form-check-label d-flex align-items-center justify-content-between w-100" for="layoutSidebar">
									<span>Thanh bên</span>
									<div class="layout-preview layout-sidebar"></div>
								</label>
							</div>
						</div>

						<!-- Tile Count Slider -->
						<div class="mb-3">
							<label class="form-label d-flex justify-content-between">
								<span>Số ô</span>
								<span class="text-muted small">Số ô tối đa được hiển thị, tùy vào kích thước của số.</span>
							</label>
							<div class="d-flex align-items-center gap-3">
								<button type="button" class="btn btn-sm btn-outline-light" id="tileCountMin"><i class="bi bi-grid"></i></button>
								<input type="range" class="form-range flex-grow-1" min="4" max="49" value="16" id="tileCountSlider">
								<span id="tileCountValue" class="badge bg-primary">16</span>
								<button type="button" class="btn btn-sm btn-outline-light" id="tileCountMax"><i class="bi bi-grid-3x3-gap-fill"></i></button>
							</div>
						</div>

						<!-- Hide non-video option -->
						<div class="form-check form-switch">
							<input class="form-check-input" type="checkbox" id="hideNoVideo">
							<label class="form-check-label" for="hideNoVideo">Ẩn ô không có video</label>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Files Modal -->
		<div class="modal fade" id="filesModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content bg-dark text-light border-secondary">
					<div class="modal-header border-secondary">
						<h5 class="modal-title"><i class="bi bi-folder"></i> Chia sẻ file</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<input type="file" class="form-control" id="fileUploadInput">
							<small class="text-muted">Tải lên file để chia sẻ với mọi người</small>
						</div>
						<button class="btn btn-primary w-100 mb-3" id="uploadFileBtn">
							<i class="bi bi-upload"></i> Tải lên
						</button>
						<hr>
						<h6>File đã chia sẻ:</h6>
						<div id="filesList" style="max-height: 300px; overflow-y: auto;">
							<p class="text-muted text-center">Đang tải...</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Roles Modal -->
		<div class="modal fade" id="rolesModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content bg-dark text-light border-secondary">
					<div class="modal-header border-secondary">
						<h5 class="modal-title"><i class="bi bi-shield-check"></i> Quản lý phân quyền</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<h6>Vai trò của bạn: <span id="myRole" class="badge bg-primary">Đang tải...</span></h6>
						</div>
						<hr>
						<h6>Người tham gia:</h6>
						<div id="participantRoles" style="max-height: 400px; overflow-y: auto;">
							<p class="text-muted text-center">Đang tải...</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Breakout Rooms Modal -->
		<div class="modal fade" id="breakoutModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content bg-dark text-light border-secondary">
					<div class="modal-header border-secondary">
						<h5 class="modal-title"><i class="bi bi-grid-3x2"></i> Breakout Rooms</h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<button class="btn btn-success w-100" onclick="window.open('/breakout?meeting=<%= room.code %>', '_blank')">
								<i class="bi bi-box-arrow-up-right"></i> Mở trang quản lý Breakout Rooms
							</button>
						</div>
						<small class="text-muted">Chỉ host mới có thể quản lý Breakout Rooms</small>
					</div>
				</div>
			</div>
		</div>

		<script>
			window.__MEETING__ = {
				code: '<%= room.code %>',
				roomId: '<%= room._id %>',
				user: { id: '<%= user.id %>', displayName: '<%= user.displayName %>' }
			}
			// Meeting clock
			function updateMeetingClock(){
				const el = document.getElementById('meetingClock')
				if(el) el.textContent = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
			}
			updateMeetingClock(); setInterval(updateMeetingClock, 1000)
		</script>
		<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script src="/js/api/fileShare.api.js"></script>
		<script src="/js/api/deviceStatus.api.js"></script>
		<script src="/js/api/role.api.js"></script>
		<script src="/meeting.js"></script>
	</body>
	</html>
